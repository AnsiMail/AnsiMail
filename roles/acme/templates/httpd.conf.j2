# Modified for AnsiMail (OpenBSD 6.6)

# CREDIT: vedetta-com/caesonia
# https://github.com/vedetta-com/caesonia

server "{{ hostname }}.{{ domain }}" {
{% if enable_nsd == true %}
	alias "{{ domain }}"
	alias "www.{{ domain }}"
{% endif %}
	alias "autoconfig.{{ domain }}"
	alias "autodiscover.{{ domain }}"
        alias "openpgpkey.{{ domain }}"
	alias "wkd.{{ domain }}"
	alias "mta-sts.{{ domain }}"
	alias "imap.{{ domain }}"
	alias "pop3.{{ domain }}"
	alias "smtp.{{ domain }}"
{% if additional_domains is defined %}
{% for adomain in additional_domains %}
	alias "autoconfig.{{ adomain }}"
        alias "autodiscover.{{ adomain }}"
        alias "openpgpkey.{{ adomain }}"
        alias "wkd.{{ adomain }}"
        alias "mta-sts.{{ adomain }}"
        alias "imap.{{ adomain }}"
	alias "pop3.{{ adomain }}"
        alias "smtp.{{ adomain }}"
{% endfor %}
{% endif %}

	listen on egress port http

	tcp nodelay

	connection { max requests 500, timeout 3600 }

	log { access "access.log", error "error.log" }

	location "/.well-known/acme-challenge/*" {
		root "/acme"
		request strip 2
	}

	location "/*" {
		block return 302 "https://$HTTP_HOST$REQUEST_URI"
	}
}


server "{{ hostname }}.{{ domain }}" {
{% if enable_nsd == true %}
	alias "{{ domain }}"
	alias "www.{{ domain }}"
{% endif %}
	alias "autoconfig.{{ domain }}"
        alias "autodiscover.{{ domain }}"
        alias "openpgpkey.{{ domain }}"
        alias "wkd.{{ domain }}"
        alias "mta-sts.{{ domain }}"
        alias "imap.{{ domain }}"
	alias "pop3.{{ domain }}"
        alias "smtp.{{ domain }}"
{% if additional_domains is defined %}
{% for adomain in additional_domains %}
	alias "autoconfig.{{ adomain }}"
        alias "autodiscover.{{ adomain }}"
        alias "openpgpkey.{{ adomain }}"
        alias "wkd.{{ adomain }}"
        alias "mta-sts.{{ adomain }}"
        alias "imap.{{ adomain }}"
	alias "pop3.{{ adomain }}"
        alias "smtp.{{ adomain }}"
{% endfor %}
{% endif %}

	listen on egress tls port https

	hsts {
		subdomains
	}

	tls {
		certificate "/etc/ansimail/ssl/{{ domain }}.fullchain.pem"
		key "/etc/ansimail/ssl/private/{{ domain }}.key"
	}

	tcp nodelay

	connection { max requests 500, timeout 3600 }

	log { access "access.log", error "error.log" }

	# SMTP MTA Strict Transport Security
	location "/.well-known/mta-sts.txt" {
		root "/mta-sts"
		request strip 1
	}

	# OpenPGP Web Key Directory
	location "/.well-known/openpgpkey/*" {
		root "/openpgpkey"
		request strip 2
	}

	location "/*" {
		root "/{{ domain }}"
	}

}


# IP defender (!) must be last server
server "nonexistent" {
	alias match "%d+%.%d+%.%d+%.%d+" # IPv4 or IPv6
	alias match "%w*::*" # IPv6

	listen on egress port http
	listen on egress port https # (!) no TLS

	tcp nodelay
	connection { max requests 500, timeout 3600 }

	log syslog

	block # nothing to see here

	root "/nonexistent"
	directory no index
}


types {
	include "/usr/share/misc/mime.types"
}
