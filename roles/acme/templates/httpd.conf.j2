# CREDIT: vedetta-com/caesonia
# https://github.com/vedetta-com/caesonia

http_port="{{ http_port }}"
http_interface="{{ http_interface }}"
https_port="{{ https_port }}"
https_interface="{{ https_interface }}"

server "{{ hostname }}.{{ domain }}" {
{% for sdomain in subdomains %}
	alias "{{ sdomain }}.{{ domain }}"
{% endfor %}
{% if additional_domains is defined %}
{% for adomain in additional_domains %}
{% for sdomain in subdomains %}
	alias "{{ sdomain }}.{{ adomain.name }}"
{% endfor %}
{% endfor %}
{% endif %}

	listen on $http_interface port $http_port

	tcp nodelay

	log { access "access.log", error "error.log" }

	location "/.well-known/acme-challenge/*" {
		root "/acme"
		request strip 2
	}

	location "/*" {
		block return 302 "https://$HTTP_HOST$REQUEST_URI"
	}
}


server "{{ hostname }}.{{ domain }}" {
{% for rdomain in required_domains %}
	alias "{{ rdomain }}.{{ domain }}"
{% endfor %}

	listen on $https_interface port $https_port

	tcp nodelay

	log { access "access.log", error "error.log" }

	# SMTP MTA Strict Transport Security
	location "/.well-known/mta-sts.txt" {
		root "/mta-sts"
		request strip 1
	}

	# OpenPGP Web Key Directory
	location "/.well-known/openpgpkey/{{ domain }}/*" {
		root "/openpgpkey/{{ domain }}"
		request strip 3
	}

	# Autodiscover file for Microsoft 
	location "/Autodiscover/*" {
		root "/Autodiscover/{{ domain }}"
		request strip 1
	}

	# OpenPGP Web Key Directory
	location "/mail/*" {
		root "/mail/{{ domain }}"
		request strip 1
	}

	# rest of the files are queried in their respective folders
	location "/*" {
		root "/htdocs/{{ domain }}"
	}
}

{% if additional_domains is defined %}
{% for adomain in additional_domains %}

server "{{ adomain.name }}" {
{% if additional_domains is defined %}
{% for rdomain in required_domains %}
	alias "{{ rdomain }}.{{ adomain.name }}"
{% endfor %}
{% endif %}

	listen on $https_interface port $https_port

	tcp nodelay

	log { access "access.log", error "error.log" }

	# SMTP MTA Strict Transport Security
	location "/.well-known/mta-sts.txt" {
		root "/mta-sts"
		request strip 1
	}

	# OpenPGP Web Key Directory
	location "/.well-known/openpgpkey/{{ adomain.name }}/*" {
		root "/openpgpkey/{{ adomain.name }}"
		request strip 3
	}

	# Autodiscover file for Microsoft 
	location "/Autodiscover/*" {
		root "/Autodiscover/{{ adomain.name }}"
		request strip 1
	}

	# OpenPGP Web Key Directory
	location "/mail/*" {
		root "/mail/{{ adomain.name }}"
		request strip 1
	}

	# rest of the files are queried in their respective folders
	location "/*" {
		root "/htdocs/{{ adomain.name }}"
	}
}

{% endfor %}
{% endif %}

types {
	include "/usr/share/misc/mime.types"
}
