# Modified for AnsiMail (OpenBSD 6.7)

# CREDIT: vedetta-com/caesonia
# https://github.com/vedetta-com/caesonia

server "openpgpkey.{{ domain }}" {
        alias "{{ hostname }}.{{ domain }}"
	alias "autoconfig.{{ domain }}"
	alias "autodiscover.{{ domain }}"
	alias "wkd.{{ domain }}"
	alias "mta-sts.{{ domain }}"
	alias "imap.{{ domain }}"
	alias "pop3.{{ domain }}"
	alias "smtp.{{ domain }}"
{% if additional_domains is defined %}
{% for adomain in additional_domains %}
	alias "openpgpkey.{{ adomain.name }}"
	alias "autoconfig.{{ adomain.name }}"
        alias "autodiscover.{{ adomain.name }}"
        alias "wkd.{{ adomain.name }}"
        alias "mta-sts.{{ adomain.name }}"
        alias "imap.{{ adomain.name }}"
	alias "pop3.{{ adomain.name }}"
        alias "smtp.{{ adomain.name }}"
{% endfor %}
{% endif %}

	listen on egress port http

	tcp nodelay

	connection { max requests 500, timeout 3600 }

	log { access "access.log", error "error.log" }

	location "/.well-known/acme-challenge/*" {
		root "/acme"
		request strip 2
	}

	location "/*" {
		block return 302 "https://$HTTP_HOST$REQUEST_URI"
	}
}


server "openpgpkey.{{ domain }}" {
        alias "{{ hostname }}.{{ domain }}"
	alias "autoconfig.{{ domain }}"
        alias "autodiscover.{{ domain }}"
        alias "wkd.{{ domain }}"
        alias "mta-sts.{{ domain }}"
        alias "imap.{{ domain }}"
	alias "pop3.{{ domain }}"
        alias "smtp.{{ domain }}"

	listen on egress tls port https

	hsts {
		subdomains
	}

	tls {
		certificate "/etc/ansimail/ssl/{{ domain }}.fullchain.pem"
		key "/etc/ansimail/ssl/private/{{ domain }}.key"
	}

	tcp nodelay

	connection { max requests 500, timeout 3600 }

	log { access "access.log", error "error.log" }

	# SMTP MTA Strict Transport Security
	location "/.well-known/mta-sts.txt" {
		root "/mta-sts"
		request strip 1
	}

	# OpenPGP Web Key Directory
	location "/.well-known/openpgpkey/{{ domain }}/*" {
		root "/openpgpkey/{{ domain }}"
		request strip 3
	}

	# Autodiscover file for Microsoft 
	location "/Autodiscover/*" {
		root "/Autodiscover/{{ domain }}"
		request strip 1
	}

	# OpenPGP Web Key Directory
	location "/mail/*" {
		root "/mail/{{ domain }}"
		request strip 1
	}
	# rest of the files are queried in their respective folders
	location "/*" {
		root "/htdocs/{{ domain }}"
	}
}

{% if additional_domains is defined %}
{% for adomain in additional_domains %}

server "openpgpkey.{{ adomain.name }}" {
	alias "autoconfig.{{ adomain.name }}"
        alias "autodiscover.{{ adomain.name }}"
        alias "wkd.{{ adomain.name }}"
        alias "mta-sts.{{ adomain.name }}"
        alias "imap.{{ adomain.name }}"
	alias "pop3.{{ adomain.name }}"
        alias "smtp.{{ adomain.name }}"

	listen on egress tls port https

	hsts {
		subdomains
	}

	tls {
		certificate "/etc/ansimail/ssl/{{ domain }}.fullchain.pem"
		key "/etc/ansimail/ssl/private/{{ domain }}.key"
	}

	tcp nodelay

	connection { max requests 500, timeout 3600 }

	log { access "access.log", error "error.log" }

	# SMTP MTA Strict Transport Security
	location "/.well-known/mta-sts.txt" {
		root "/mta-sts"
		request strip 1
	}

	# OpenPGP Web Key Directory
	location "/.well-known/openpgpkey/{{ adomain.name }}/*" {
		root "/openpgpkey/{{ adomain.name }}"
		request strip 3
	}

	# Autodiscover file for Microsoft 
	location "/Autodiscover/*" {
		root "/Autodiscover/{{ adomain.name }}"
		request strip 1
	}

	# OpenPGP Web Key Directory
	location "/mail/*" {
		root "/mail/{{ adomain.name }}"
		request strip 1
	}
	# rest of the files are queried in their respective folders
	location "/*" {
		root "/htdocs/{{ adomain.name }}"
	}
}

{% endfor %}
{% endif %}

# IP defender (!) must be last server
server "nonexistent" {
	alias match "%d+%.%d+%.%d+%.%d+" # IPv4 or IPv6
	alias match "%w*::*" # IPv6

	listen on egress port http
	listen on egress port https # (!) no TLS

	tcp nodelay
	connection { max requests 500, timeout 3600 }

	log syslog

	block # nothing to see here

	root "/nonexistent"
	directory no index
}

types {
	include "/usr/share/misc/mime.types"
}
